<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cypress Admin Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js" type="module"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js" type="module"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="container">
  <aside class="sidebar">
    <div class="logo">
      <div class="icon">ğŸ›¡ï¸</div>
      <div class="title">
        <h2>Cypress</h2>
        <span>Admin Dashboard</span>
      </div>
    </div>
    <nav>
      <ul class="sidebar-menu">
        <li class="{% if request.path == url_for('admin_dashboard') %}active{% endif %}">
          <a href="{{ url_for('admin_dashboard') }}"><span class="icon">ğŸ </span> Dashboard</a>
        </li>
        <li class="{% if request.path == url_for('admin_residents') %}active{% endif %}">
          <a href="{{ url_for('admin_residents') }}"><span class="icon">ğŸ‘¥</span> Residents</a>
        </li>
        <li class="{% if request.path == url_for('admin_visitors') %}active{% endif %}">
          <a href="{{ url_for('admin_visitors') }}"><span class="icon">ğŸ‘¤</span> Visitors</a>
        </li>
        <li><a href="#"><span class="icon">ğŸ”²</span> QR Codes</a></li>
        <li class="{% if request.path == url_for('admin_reports') %}active{% endif %}">
          <a href="{{ url_for('admin_reports') }}"><span class="icon">ğŸ“„</span> Reports</a>
        </li>
        <li class="{% if request.path == url_for('admin_settings') %}active{% endif %}">
          <a href="{{ url_for('admin_settings') }}"><span class="icon">âš™ï¸</span> Settings</a>
        </li>
      </ul>
    </nav>
  </aside>

  <main class="main-content">
    <header class="top-bar">
      <div class="search-bar">
        <input type="search" placeholder="Search residents, visitors, plates..." />
      </div>
      <div class="top-icons">
        <button class="icon-btn">ğŸ””<span class="notification-count">{{ notifications|length }}</span></button>
        <button class="icon-btn">ğŸ‘¤</button>
      </div>
    </header>

    <section class="dashboard-header">
      <h1>Dashboard</h1>
      <p>Welcome to Cypress Subdivision Admin Panel</p>
      <div class="actions">
        <button class="filter-btn">Filter</button>
        <button class="export-btn">Export</button>
      </div>
    </section>

    <section class="stats-cards">
      <div class="card">
        <p>Total Residents</p>
        <h2>{{ total_residents }}</h2>
        <div class="card-icon green">ğŸ‘¤</div>
        <span class="percentage positive">+12%</span>
      </div>

      <div class="card">
        <p>Active Visitors</p>
        <h2>{{ active_visitors }}</h2>
        <div class="card-icon blue">ğŸ‘¥</div>
        <span class="percentage positive">+5%</span>
      </div>

      <div class="card">
        <p>Valid QR Codes</p>
        <h2>{{ valid_qr_codes }}</h2>
        <div class="card-icon green">ğŸ”²</div>
        <span class="percentage positive">+8%</span>
      </div>

      <div class="card">
        <p>Vehicles Registered</p>
        <h2>{{ total_vehicles }}</h2>
        <div class="card-icon yellow">ğŸš—</div>
        <span class="percentage positive">+15%</span>
      </div>

      <div class="card">
        <p>Entry Logs Today</p>
        <h2>{{ entry_logs_today }}</h2>
        <div class="card-icon green-dark">ğŸ“ˆ</div>
        <span class="percentage positive">+22%</span>
      </div>

      <div class="card">
        <p>Properties</p>
        <h2>{{ total_properties }}</h2>
        <div class="card-icon gray">ğŸ¢</div>
        <span class="percentage neutral">0%</span>
      </div>
    </section>

    <!-- ğŸ”¹ Charts Section -->
    <section class="charts-section">
      <h3>Analytics Overview</h3>
      <div style="display: flex; gap: 20px; flex-wrap: wrap;">
        <canvas id="vehicleTypeChart" width="300" height="300"></canvas>
        <canvas id="purposeChart" width="300" height="300"></canvas>
        <canvas id="dailyVisitorsChart" width="600" height="300"></canvas>
      </div>
    </section>

    <section class="tables-section">
      <div class="table-container">
        <h3>Recent Visitors <a href="#" class="view-all">View All</a></h3>
        <table id="visitorTable">
          <thead>
            <tr>
              <th>Name</th>
              <th>Purpose</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for visitor in visitors %}
            <tr>
              <td><strong>{{ visitor.fullName }}</strong></td>
              <td>{{ visitor.purpose }}</td>
              <td>
                <span class="status {% if visitor.status == 'Active' %}active{% else %}expired{% endif %}">
                  {{ visitor.status }}
                </span>
              </td>
              <td>ğŸ‘ï¸</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="table-container">
        <h3>Resident Activity <a href="#" class="view-all">View All</a></h3>
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Address</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for resident in residents %}
            <tr>
              <td><strong>{{ resident.fullName }}</strong></td>
              <td>{{ resident.address }}</td>
              <td><span class="status {% if resident.status == 'Active' %}active{% else %}suspended{% endif %}">{{ resident.status }}</span></td>
              <td>ğŸ‘ï¸</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
  </main>
</div>

<!-- Your admin.js -->
<script src="{{ url_for('static', filename='js/admin.js') }}"></script>

<!-- Firebase + Charts Script -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

  // âœ… Replace with your Firebase config
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const visitorsRef = ref(db, "visitors");

  onValue(visitorsRef, (snapshot) => {
    const data = snapshot.val();
    if (!data) return;

    const visitors = Object.values(data);

    // --- Vehicle Types Count ---
    const vehicleCounts = {};
    visitors.forEach(v => {
      const type = v.vehicleType || "Unknown";
      vehicleCounts[type] = (vehicleCounts[type] || 0) + 1;
    });

    // --- Purposes Count ---
    const purposeCounts = {};
    visitors.forEach(v => {
      const purpose = v.purpose || "Other";
      purposeCounts[purpose] = (purposeCounts[purpose] || 0) + 1;
    });

    // --- Daily Visitors Count ---
    const dailyCounts = {};
    visitors.forEach(v => {
      const date = (v.visitDate || "").split("T")[0]; 
      if (date) {
        dailyCounts[date] = (dailyCounts[date] || 0) + 1;
      }
    });

    // --- Render Charts ---
    new Chart(document.getElementById("vehicleTypeChart"), {
      type: "pie",
      data: {
        labels: Object.keys(vehicleCounts),
        datasets: [{
          data: Object.values(vehicleCounts),
          backgroundColor: ["#4CAF50", "#2196F3", "#FFC107", "#FF5722"]
        }]
      }
    });

    new Chart(document.getElementById("purposeChart"), {
      type: "bar",
      data: {
        labels: Object.keys(purposeCounts),
        datasets: [{
          label: "Purpose of Visit",
          data: Object.values(purposeCounts),
          backgroundColor: "#2196F3"
        }]
      }
    });

    new Chart(document.getElementById("dailyVisitorsChart"), {
      type: "line",
      data: {
        labels: Object.keys(dailyCounts),
        datasets: [{
          label: "Visitors Per Day",
          data: Object.values(dailyCounts),
          borderColor: "#4CAF50",
          fill: false,
          tension: 0.1
        }]
      }
    });
  });
</script>
</body>
</html>
